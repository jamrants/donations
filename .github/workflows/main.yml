name: CI

# This action works with pull requests and pushes
on:
  pull_request:
  push:
    branches:
    - master
  repository_dispatch:
    types: [airtable]

jobs:
  prettier:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2
      with:
        # Make sure the actual branch is checked out when running on pull requests
        ref: ${{ github.head_ref }}

    - name: Prettify Code
      uses: creyD/prettier_action@v3.0
      with:
        # This part is also where you can pass other options, for example:
        prettier_options: --write **/*.{js,md,yml}
  
  lighthouseci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
      - run: npm install && npm install -g @lhci/cli@0.4.x
      - run: npm run build
      - run: lhci autorun --upload.target=temporary-public-storage
  
  build:
    needs: [prettier]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2

    - name: Cache node_modules
      id: cache-node-modules
      uses: actions/cache@v1
      with:
        path: node_modules
        key: ${{ runner.os }}-build-npm-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-build-npm-
      
    - name: Install Dependencies
      if: steps.cache-node-modules.outputs.cache-hit != 'true'
      run: npm install

    - name: Build Static Files
      run: npm run build
      env:
        AIRTABLE_KEY: ${{ secrets.AIRTABLE_KEY }}
        BASE_ID: ${{ secrets.BASE_ID }}
        LOCATIONIQ: ${{ secrets.LOCATIONIQ }}
    
    - name: Deploy to Netlify
      uses: nwtgck/actions-netlify@v1.1.2
      with:
        # Publish directory
        publish-dir: './public'
        production-branch: master
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "Deploy from GitHub Actions"
      env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
